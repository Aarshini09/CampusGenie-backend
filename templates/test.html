<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusGenie - AI Assistant</title>
    <link rel="stylesheet" href="{{url_for('static',filename='style.css')}}">
</head>
<body>

<div class="mobile-container">
    
    <div class="header">
        <h2>CampusGenie üßû‚Äç‚ôÇÔ∏è</h2>
        <p>AI Assistant ‚Ä¢ IIT Patna</p>
    </div>

    <div id="home-screen" class="screen active">
        <p style="font-weight: 600; font-size: 14px; margin-bottom: 15px; color: #94a3b8;">QUICK ACTIONS</p>
        
        <button class="btn-main" onclick="goToScreen('analyze-screen')">
            <span>üìù</span> Paste WhatsApp Message
        </button>

        <button class="btn-main" onclick="goToScreen('tutor-screen')">
            <span>ü§ñ</span> Ask a Doubt (AI Tutor)
        </button>

        <button class="btn-main btn-panic" onclick="triggerPanicMode()">
            <span>üö®</span> PANIC MODE
        </button>

        <p style="font-weight: 600; font-size: 14px; margin-top: 25px; margin-bottom: 15px; color: #94a3b8;">UPCOMING DEADLINES</p>
        
        <div class="card" style="border-left: 4px solid #f59e0b;">
            <h3>CS101 Assignment</h3>
            <p>üìÖ Tomorrow, 11:59 PM</p>
            <p style="font-size: 12px; color: #f59e0b;">‚óè Priority: High</p>
        </div>
    </div>

    <div id="analyze-screen" class="screen">
        <h3>Analyze Message</h3>
        <p>Paste your group message below:</p>
        
        <textarea id="msgInput" placeholder="Example: 'Guys, Maths quiz is scheduled for Friday at 10 AM...'"></textarea>
        
        <button id="btn-analyze" class="btn-main btn-primary" onclick="callAnalyzeAPI()">
            ‚ú® Analyze Now (API)
        </button>
        <button onclick="goToScreen('home-screen')" style="background:none; border:none; color:#94a3b8; width:100%; margin-top:10px; cursor:pointer;">Cancel</button>
    </div>

    <div id="result-screen" class="screen">
        <h3>Analysis Result</h3>
        <p style="color: #10B981; font-weight: bold; font-size: 14px;">‚úÖ AI Found 1 Deadline</p>

        <div class="card">
            <h3 id="res-title">Loading title...</h3>
            <p id="res-date">üìÖ Loading date...</p>
            <p id="res-desc" style="font-size: 12px; margin-top:5px; color: #888;">...</p>
            
            <button id="btn-calendar" class="btn-add-calendar" onclick="callCalendarAPI()">
                üìÖ Add to Calendar (Droidrun)
            </button>
        </div>

        <button class="btn-main" style="margin-top: 20px;" onclick="goToScreen('home-screen')">Back to Home</button>
    </div>

    <div id="tutor-screen" class="screen">
        <h3>AI Tutor üß†</h3>
        <p>Enter a topic to get an explanation:</p>
        <textarea id="tutorInput" placeholder="Ex: Explain Schrodinger's Wave Equation..."></textarea>
        
        <button id="btn-tutor" class="btn-main btn-primary" onclick="callTutorAPI()">
            ‚ú® Explain Topic
        </button>
        <button onclick="goToScreen('home-screen')" style="background:none; border:none; color:#94a3b8; width:100%; margin-top:10px; cursor:pointer;">Back</button>
    </div>

    <div id="explanation-screen" class="screen">
        <h3>üß† AI Explanation:</h3>
        <div class="card">
            <p id="tutor-result" style="white-space: pre-wrap; line-height: 1.6;">Loading explanation...</p>
        </div>
        <button class="btn-main" onclick="goToScreen('tutor-screen')">Ask Another Doubt</button>
        <button class="btn-main" onclick="goToScreen('home-screen')">Home</button>
    </div>

    <div id="success-popup">
        <div>‚úÖ</div>
        <h3>Synced!</h3>
        <p>Droidrun Trigger Successful.</p>
    </div>

</div>
    let lastTaskTitle = "";
    let lastTaskDate = "";
    let lastTasksSummary = "";

<script>
    // URL Here
    const API_BASE_URL = "https://campusgenie-api.onrender.com";
    let lastTaskTitle = "";
    let lastTaskDate = "";
    let lastTasksSummary = "";

    function goToScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    function showLoading(btnId, isLoading) {
        const btn = document.getElementById(btnId);
        if (isLoading) {
            btn.dataset.originalText = btn.innerText;
            btn.innerText = "‚è≥ Connecting...";
            btn.style.opacity = "0.7";
            btn.disabled = true;
        } else {
            btn.innerText = btn.dataset.originalText;
            btn.style.opacity = "1";
            btn.disabled = false;
        }
    }

    // -- API 1: ANALYZE MESSAGE --
    async function callAnalyzeAPI() {
        const text = document.getElementById('msgInput').value;
        
        // -- FIXED ALERT HERE --
        if(!text) return alert("Please paste a message first!"); 

        showLoading('btn-analyze', true);

        try {
            const response = await fetch('https://campusgenie-api.onrender.com/analyze', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: text })
            });

            const data = await response.json();

            const title = typeof data.title === "object" ? JSON.stringify(data.title) : data.title;
            const date = typeof data.date === "object" ? JSON.stringify(data.date) : data.date;
            const summary = typeof data.summary === "object" ? JSON.stringify(data.summary) : data.summary;

           document.getElementById('res-title').innerText = title || "No Title Found";
           document.getElementById('res-date').innerText = "üìÖ " + (date || "No Date");
           document.getElementById('res-desc').innerText = "Source: " + (summary || "No Summary");
            lastTaskTitle = title;
            lastTaskDate = date;
            lastTasksSummary = summary;

            goToScreen('result-screen');

        } catch (error) {
            console.error(error);
            // -- FIXED ALERT HERE --
            alert("Error: Could not connect to Backend! (Check URL)");
        } finally {
            showLoading('btn-analyze', false);
        }
    }

    // --- API 2: ADD TO CALENDAR ---
    async function callCalendarAPI() {
        showLoading('btn-calendar', true);

        try {
            const response = await fetch(`${API_BASE_URL}/add-to-calendar`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title: lastTaskTitle, date: lastTaskDate, description: lastTaskSummary})
            });

            const data = await response.json();

            if (response.ok) {
                const popup = document.getElementById('success-popup');
                popup.style.display = 'block';
                setTimeout(() => popup.style.display = 'none', 3000);
            } else {
                alert("Droidrun Error: " + data.error);
            }

        } catch (error) {
            // --- FIXED ALERT HERE ---
            alert("Failed to trigger Droidrun. Check connection.");
        } finally {
            showLoading('btn-calendar', false);
        }
    }

    // --- API 3: AI TUTOR ---
    async function callTutorAPI() {
        const topic = document.getElementById('tutorInput').value;
        
        // --- FIXED ALERT HERE ---
        if(!topic) return alert("Please enter a topic!");

        showLoading('btn-tutor', true);

        try {
            const response = await fetch(`${API_BASE_URL}/explain`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ topic: topic })
            });

            const data = await response.json();
            document.getElementById('tutor-result').innerText = data.explanation || "No answer received.";
            goToScreen('explanation-screen');

        } catch (error) {
            console.error(error);
            // --- FIXED ALERT HERE ---
            alert("AI Tutor could not connect.");
        } finally {
            showLoading('btn-tutor', false);
        }
    }

    // --- PANIC MODE ---
    function triggerPanicMode() {
        // --- FIXED ALERT HERE ---
        alert("üö® PANIC MODE ACTIVATED: Blocking Apps & Starting Timer...");
    }

</script>

</body>
</html>
